name: Fly Deploy
on:
  push:
    tags: [ 'v*' ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Backend Tests
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'
          cache: false

      - name: Tidy Go Modules
        run: cd server && go mod tidy
        
      - name: Run Go Tests
        run: cd server && go test ./...

      # Frontend Tests (Cypress)
      - name: Cypress run
        uses: cypress-io/github-action@v6
        with:
          working-directory: client
          install-command: npm install
          build: npm run build
          start: npm run dev -- --host
          wait-on: 'http://localhost:5173'
          wait-on-timeout: 120

  deploy:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      - uses: superfly/flyctl-actions/setup-flyctl@master
      # Switched to --local-only to bypass remote builder network errors
      - run: flyctl deploy --local-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

  release:
    runs-on: ubuntu-latest
    needs: deploy 
    permissions:
      contents: write 
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ### Kielibuddy Automated Release
            - **Status:** Phase 1 (Landing Page)
            - **Live URL:** https://kielibuddy.fly.dev
            - Built with Go 1.23 and React 22 (Vite)
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}